#user pong_daemon_role;
user "superuser";
worker_processes auto;
pid /run/nginx.pid;
#error_log syslog:server=unix:/dev/log warning;
#access_log syslog:server=unix:/dev/log warning;


events
{
	worker_aio_requests 12500;
	worker_connections 100000;
}

http
{
	error_log stderr info;
	access_log stdout;

	upstream api
	{
		least_conn;
		server unix:/home/superuser/pong/api_sockets/api_worker_1.sock;
	}

	client_header_timeout 4s;
	client_body_timeout 4s;
	keepalive_timeout 4s;
	send_timeout 4s;
	proxy_connect_timeout 1s;
	proxy_read_timeout 1d;
	proxy_send_timeout 1s;
	lingering_close off;

	client_header_buffer_size 4k;
	large_client_header_buffers 1 512;

	ssl_buffer_size 4k;
	ssl_session_timeout 1d;
	ssl_session_cache shared:ssl_session_store:25m; # number of cpu cores time the number of worker_connections divided by 4000
								  # (result in mb)

	sendfile on;
	types_hash_max_size 2048;
	include /etc/nginx/mime.types;

	gzip on;

	gzip_proxied any;
	gzip_comp_level 4;
	gzip_buffers 2 5k;
	gzip_types "*";

	http2 on;

	server
	{
		listen 443 ssl;
		server_name _;
		ssl_reject_handshake on;

		return 444;
	}

	server
	{
		listen 443 ssl reuseport;
		server_name pong.com;
		ssl_certificate     /home/superuser/pong/nginx_config/pong.com.crt;
		ssl_certificate_key /home/superuser/pong/nginx_config/pong.com.key;

		proxy_http_version 1.1;
		location /
		{
			proxy_pass http://api;
		}
	}

	server
	{
		listen 80 reuseport;
		server_name _;

		return 444;
	}

	server
	{
		listen 80 ;
		server_name pong.com;

		proxy_http_version 1.1;
		location /
		{
			proxy_pass http://api;
		}
	}
}
